"use strict";function e(e,r,n){return{__name:e.__name,__primaryKey:e.__primaryKey,__has:r,__alias:n}}var r=function(){return r=Object.assign||function(e){for(var r,n=1,t=arguments.length;n<t;n++)for(var a in r=arguments[n])Object.prototype.hasOwnProperty.call(r,a)&&(e[a]=r[a]);return e},r.apply(this,arguments)};function n(e,r){for(var n=0,t=Object.entries(e);n<t.length;n++){var a=t[n],i=a[0],_=a[1];if(r[i]!==_)return!1}return!0}function t(e,r){if(!r)return null;var n={};function t(e){e.forEach((function(e){var t=r[e];void 0!==t&&(n[e]=t)}))}return t("*"===e?Object.keys(r):e),n}function a(e,_,o){var c=o.from,f=o.where,s=o.fields,u=o.join;if(Array.isArray(f))return f.flatMap((function(n){var t;return null!==(t=a(e,_,r(r({},o),{where:n})))&&void 0!==t?t:[]}));var y=null,l=e[c],m=_[c];if(!m)return null;if("*"===f&&(y=Object.values(m).flatMap((function(e){var r;return null!==(r=t(s,e))&&void 0!==r?r:[]}))),"object"==typeof f){var p=f[l.__primaryKey];if(p)(x=t(s,m[p]))&&(y=x);if(!p){y=[];for(var d=0,h=Object.entries(m);d<h.length;d++){var v=h[d];if(v[0],n(f,b=v[1]))(x=t(s,b))&&y.push(x)}}}if("function"==typeof f){y=[];for(var O=0,K=Object.entries(m);O<K.length;O++){var b,x,j=K[O];if(j[0],f(b=j[1]))(x=t(s,b))&&y.push(x)}}return y&&u&&(Array.isArray(y)&&y.forEach((function(r){i(r,{join:u,from:c,model:e,state:_})})),Array.isArray(y)||i(y,{join:u,from:c,model:e,state:_})),y}function i(e,r){var n=r.join,t=r.from,_=r.model,o=r.state,c=_[t];Object.values(n.reduce((function(e,r){return e[r.on]=r,e}),{})).forEach((function(r){var n,f=r.on,s=r.fields,u=r.join;if(e[f]){if(!c.__relationship[f])throw new Error('Field "'.concat(String(f),'" does not exist in object "').concat(t,'"'));if("hasOne"===c.__relationship[f].__has&&(e[f]=a(_,o,{fields:s,from:c.__relationship[f].__name,where:(n={},n[c.__relationship[f].__primaryKey]=e[f],n)})),"hasMany"===c.__relationship[f].__has){var y=[];e[f].forEach((function(e){var r,n=a(_,o,{fields:s,from:c.__relationship[f].__name,where:(r={},r[c.__relationship[f].__primaryKey]=e,r)});n&&y.push(n)})),e[f]=y}u&&("hasOne"===c.__relationship[f].__has&&i(e[f],{from:c.__relationship[f].__name,join:u,model:_,state:o}),"hasMany"===c.__relationship[f].__has&&e[f].forEach((function(e){i(e,{from:c.__relationship[f].__name,join:u,model:_,state:o})})))}}))}function _(e){if(null===e||"object"!=typeof e)return e;var r=Array.isArray(e)?[]:{};for(var n in e)e.hasOwnProperty(n)&&(r[n]=_(e[n]));return r}function o(e,r){if(e===r)return!0;if("object"!=typeof e||"object"!=typeof r||null===e||null===r)return!1;var n=Object.keys(e),t=Object.keys(r);if(n.length!==t.length)return!1;for(var a=0,i=n;a<i.length;a++){var _=i[a];if(!t.includes(_)||!o(e[_],r[_]))return!1}return!0}function c(e){var r=new Map;return function(){for(var n=[],t=0;t<arguments.length;t++)n[t]=arguments[t];var a=JSON.stringify(n),i=e.apply(void 0,n),_=r.get(a);return r.has(a)&&o(_,i)?_:(r.set(a,i),i)}}function f(e,r){return Array.isArray(e)?e.map((function(e){return s(e,r)})):s(e,r)}function s(e,r){return"function"==typeof r.__destroy__?e.__destroy__=r.__destroy__(e):r.__destroy__&&(e.__destroy__=r.__destroy__),"function"==typeof r.__identify__?e.__identify__=r.__identify__(e):r.__identify__&&(e.__identify__=r.__identify__),"function"==typeof r.__indexes__?e.__indexes__=r.__indexes__(e):r.__indexes__&&(e.__indexes__=r.__indexes__),"function"==typeof r.__removeFromIndexes__?e.__removeFromIndexes__=r.__removeFromIndexes__(e):r.__removeFromIndexes__&&(e.__removeFromIndexes__=r.__removeFromIndexes__),e}"function"==typeof SuppressedError&&SuppressedError,exports.createRelationalObject=function(r,n){var t={__name:r,__primaryKey:null!=n?n:"id",__relationship:{},__indexes:[]};return Object.setPrototypeOf(t,{hasOne:function(r,n){var t=this,a=null!=n?n:r.__name,i=Object.entries(t.__relationship).find((function(e){return e[0],e[1].__name===r.__name}));if(i&&t.__relationship[i[0]].__primaryKey===r.__primaryKey&&r.__primaryKey===t.__name)throw new Error('"'.concat(r.__name,'" reference already exists in "').concat(t.__name,'" as "').concat(i[0],'" with the primary key (pk) "').concat(r.__primaryKey,'". "').concat(t.__name,'" table failed to create a hasOne relationship with "').concat(a,'" because it has the same primary key "').concat(r.__primaryKey,'" as "').concat(i[0],'". The primary key for "').concat(i[0],'" and "').concat(a,'" are not unique.'));return t.__relationship[a]=e(r,"hasOne",a),this},hasMany:function(r,n){var t=this,a=null!=n?n:r.__name,i=Object.entries(t.__relationship).find((function(e){return e[0],e[1].__name===r.__name}));if(i&&t.__relationship[i[0]].__primaryKey===r.__primaryKey&&r.__primaryKey===t.__name)throw new Error('"'.concat(r.__name,'" reference already exists in "').concat(t.__name,'" as "').concat(i[0],'" with the primary key (pk) "').concat(r.__primaryKey,'". "').concat(t.__name,'" table failed to create a hasOne relationship with "').concat(a,'" because it has the same primary key "').concat(r.__primaryKey,'" as "').concat(i[0],'". The primary key for "').concat(i[0],'" and "').concat(a,'" are not unique.'));return t.__relationship[a]=e(r,"hasMany",a),this}}),t},exports.createRelationalObjectIndex=function(e,r,n){return{__name:e,__objects:r.map((function(e){return e.__name})),__sort:null!=n?n:null}},exports.createStore=function(e){var n,t,i=e.relationalCreators,o=e.indexes,s=e.identifier,u=e.initialStore,y={current:null!==(n=null==u?void 0:u.references)&&void 0!==n?n:{},upsert:function(e){this.current[e.name]||(this.current[e.name]={}),this.current[e.name][e.primaryKey]?this.current[e.name][e.primaryKey].includes(e.ref)||this.current[e.name][e.primaryKey].push(e.ref):this.current[e.name][e.primaryKey]=[e.ref]},remove:function(e){var r=e.name,n=e.primaryKey,t=e.ref;this.current[r][n]=this.current[r][n].filter((function(e){return e!==t}))}},l=null!==(t=null==u?void 0:u.state)&&void 0!==t?t:{},m=new Set,p=i.reduce((function(e,n){var t;n.hasOne,n.hasMany;var a=function(e,r){var n={};for(var t in e)Object.prototype.hasOwnProperty.call(e,t)&&r.indexOf(t)<0&&(n[t]=e[t]);if(null!=e&&"function"==typeof Object.getOwnPropertySymbols){var a=0;for(t=Object.getOwnPropertySymbols(e);a<t.length;a++)r.indexOf(t[a])<0&&Object.prototype.propertyIsEnumerable.call(e,t[a])&&(n[t[a]]=e[t[a]])}return n}(n,["hasOne","hasMany"]);return r(r({},e),((t={})[a.__name]=a,t))}),{});function d(e){var r=_(Array.isArray(e)?e:[e]),n=r.reduce((function(e,r){if("string"==typeof r.__indexes__)return e.push(r.__indexes__.split("-")),e;if(r.__indexes__){var n=r.__indexes__.map((function(e){return e.split("-")}));e.push.apply(e,n)}return e}),[]);function t(e){var r=e.item,n=e.name,a=e.primaryKey,i=p[n];Object.entries(i.__relationship).forEach((function(e){var i,_=e[0],o=e[1];if(l[n][r[a]]){var c=l[n][r[a]][_];if(c)if("hasMany"!==o.__has){var f=y.current[o.__name][c];if(f){var s=f.every((function(e){var t=e.split("."),i=t[0],_=t[1];return i===n&&_===String(r[a])}));if(!s)return;t({item:(i={},i[o.__primaryKey]=c,i),name:o.__name,primaryKey:o.__primaryKey}),delete y.current[o.__name][c],delete l[o.__name][c]}}else c.forEach((function(e){var i,_=y.current[o.__name][e].every((function(e){var t=e.split("."),i=t[0],_=t[1];return i===n&&_===String(r[a])}));_&&(t({item:(i={},i[o.__primaryKey]=e,i),name:o.__name,primaryKey:o.__primaryKey}),delete y.current[o.__name][e],delete l[o.__name][e])}))}})),delete l[n][r[a]],i.__indexes.forEach((function(e){var t=l[e],i="".concat(n,"-").concat(r[a]),_=t.indexOf(i);-1!==_&&t.splice(_,1)}))}function a(e){var r=e.name,n=e.item,t=e.parentName,a=e.primaryKey,i=e.parentPrimaryKey,_=e.relationalObject,o=Object.values(_.__relationship).find((function(e){return e.__name===t}));if(o&&("hasOne"===o.__has&&(y.upsert({name:o.__name,primaryKey:i,ref:"".concat(r,".").concat(n[a],".").concat(o.__alias)}),l[r][n[a]][o.__alias]=i),"hasMany"===o.__has)){var c=l[r][n[a]][o.__alias];if(!Array.isArray(c))return y.upsert({name:o.__name,primaryKey:i,ref:"".concat(r,".").concat(n[a],".").concat(o.__alias)}),void(l[r][n[a]][o.__alias]=[i]);!!c.find((function(e){return e===i}))||(y.upsert({name:o.__name,primaryKey:i,ref:"".concat(r,".").concat(n[a],".").concat(o.__alias)}),c.push(i))}}function i(e){var r=e.item,n=e.parentName,_=e.parentField,o=e.parentFieldHasMany,c=e.parentPrimaryKey,f=function(e){if("__identify__"in e){var r=e.__identify__;return delete e.__identify__,r}for(var n in s)if(Object.prototype.hasOwnProperty.call(s,n)&&(0,s[n])(e))return n;throw new Error("Identifier was not able to identify this object ".concat(JSON.stringify(e)))}(r),u=p[f],m=u.__primaryKey;if(!r[m])throw new Error('Expected object "'.concat(f,'" to have a primaryKey "').concat(m,'".'));if("__destroy__"in r){if(r.__destroy__)return function(e){var r=e.item,n=e.name,a=e.primaryKey;if(l[n])if(y.current[n]){var i=r[a],_=y.current[n][i];_&&(_.forEach((function(e){var r=e.split("."),n=r[0],t=r[1],a=r[2];if(l[n][t])if("hasMany"===p[n].__relationship[a].__has){var _=l[n][t][a].indexOf(i);if(-1!==_){if(1===l[n][t][a].length)return void delete l[n][t][a];l[n][t][a].splice(_,1)}}else delete l[n][t][a]})),delete y.current[n][i]),t({item:r,name:n,primaryKey:a})}else t({item:r,name:n,primaryKey:a})}({item:r,name:f,primaryKey:m});delete r.__destroy__}if(l[f]||(l[f]={}),l[f][r[m]]||(l[f][r[m]]={}),"__indexes__"in r){var d="string"==typeof r.__indexes__?[r.__indexes__]:r.__indexes__;null==d||d.forEach((function(e){var n=e.split("-")[0],t=p[n];if(null==t?void 0:t.__objects.includes(f)){u.__indexes.includes(e)||u.__indexes.push(e),l[e]||(l[e]=[]);var a="".concat(f,"-").concat(r[m]);l[e].includes(a)||l[e].push(a)}})),delete r.__indexes__}if("__removeFromIndexes__"in r){var h="string"==typeof r.__removeFromIndexes__?[r.__removeFromIndexes__]:r.__removeFromIndexes__;null==h||h.forEach((function(e){if(l[e]){var n="".concat(f,"-").concat(r[m]),t=l[e].indexOf(n);t>-1&&l[e].splice(t,1)}})),delete r.__removeFromIndexes__}function v(e,r){var n,t=e.split("."),a=t[0],i=t[1],_=t[2],o=p[a].__relationship[_],c=p[o.__name],f=null===(n=Object.values(c.__relationship).find((function(e){return e.__name===a})))||void 0===n?void 0:n.__alias;if(!f)throw new Error("".concat(c.__name," did not have an alias. This was unexpected. Report this bug."));y.remove({name:o.__name,primaryKey:r,ref:e}),y.remove({name:a,primaryKey:i,ref:"".concat(o.__name,".").concat(r,".").concat(f)});var s=l[o.__name][r][f];Array.isArray(s)?l[o.__name][r][f]=s.filter((function(e){return e!=i})):delete l[o.__name][r][f],delete l[a][i][_]}if(Object.entries(r).forEach((function(e){var n,t=e[0],a=e[1],_=u.__relationship[t];if(_){if(!("hasMany"===_.__has)){if(null===r[t]){var o=l[f][r[m]][t];return void v("".concat(f,".").concat(r[m],".").concat(t),o)}if("object"!=typeof r[t]){if(!l[_.__name][r[t]])throw new Error("".concat(_.__name," with primaryKey ").concat(r[t]," does not exist."));return void(l[f][r[m]][t]=r[t])}if(null===r[t]||void 0===r[t]||"object"!=typeof r[t])return;return void i({item:r[t],parentPrimaryKey:r[m],parentField:t,parentName:f})}if(r[t].every((function(e){return"object"!=typeof e}))){for(var c=r[m],s=l[f][c][t],p=[],d=function(e){var a=s[e];if(!r[t].includes(a))return(null===(n=y.current[_.__name])||void 0===n?void 0:n[a]).forEach((function(e){return v(e,a)})),"continue";p.push(a)},h=0;h<(null==s?void 0:s.length);h++)d(h);return void(l[f][c][t]=p)}if(null===r[t]||void 0===r[t]||"object"!=typeof r[t])return;r[t].forEach((function(e){i({item:e,parentPrimaryKey:r[m],parentField:t,parentName:f,parentFieldHasMany:!0})}))}else l[f][r[m]][t]=a})),n&&_&&c){if(o){var O=l[n][c][_];return Array.isArray(O)?void(!!O.find((function(e){return e===r[m]}))||(y.upsert({name:f,primaryKey:r[m],ref:"".concat(n,".").concat(c,".").concat(_)}),O.push(r[m]),a({name:f,item:r,parentName:n,parentPrimaryKey:c,primaryKey:m,relationalObject:u}))):(y.upsert({name:f,primaryKey:r[m],ref:"".concat(n,".").concat(c,".").concat(_)}),l[n][c][_]=[r[m]],void a({name:f,item:r,parentName:n,parentPrimaryKey:c,primaryKey:m,relationalObject:u}))}y.upsert({name:f,primaryKey:r[m],ref:"".concat(n,".").concat(c,".").concat(_)}),l[n][c][_]=r[m],a({name:f,item:r,parentName:n,parentPrimaryKey:c,primaryKey:m,relationalObject:u})}}r.forEach((function(e){return!!e&&i({item:e})})),null==n||n.forEach((function(e){var r=e[0],n=e[1],t=p[r].__sort,a="".concat(r,"-").concat(n);t&&l[a]&&l[a].sort((function(e,r){var n=e.split("-"),a=n[0],i=n[1],_=r.split("-"),o=_[0],c=_[1];return t(l[a][i],l[o][c])}))})),m.forEach((function(e){return e()}))}null==o||o.forEach((function(e){return p[e.__name]=e}));var h=c((function(e){return a(p,l,e)})),v=c((function(e,n){var t=l[e],i=[];return t?(t.forEach((function(t){var _,o=t.split("-"),c=o[0],f=o[1],s=p[c].__primaryKey,u=n?n[c]:{from:c,fields:"*"};if(!u)throw new Error('selectIndex() expected SelectOptions for "'.concat(c,'" in the index "').concat(e,'".'));var y=a(p,l,r(r({},u),{where:(_={},_[s]=f,_)}));if(y)return(null==u?void 0:u.where)?void(("function"!=typeof(null==u?void 0:u.where)||(null==u?void 0:u.where(y)))&&i.push(y)):i.push(y)})),i):null}));return{save:function(e){e({state:l,references:y.current})},restore:function(e){y.current=e.references,Object.entries(e.state).map((function(e){var r=e[0],n=e[1];return l[r]=n}))},getState:function(){return l},getReferences:function(){return y.current},purge:function(){for(var e in l){if(!Object.prototype.hasOwnProperty.call(l,e))return;delete l[e]}y.current={}},select:h,selectIndex:v,mutate:d,mutateWhere:function(e,n){var t=h(e),a=n(t);if(a)return Array.isArray(a)?d(f(a,{__identify__:e.from})):t?void d(r(r(r({},t),a),{__identify__:e.from})):d(r(r({},a),{__identify__:e.from}))},subscribe:function(e){return m.add(e),function(){return m.delete(e)}},destroy:function(e){delete l[e]}}},exports.withOptions=f;
