"use strict";var e=function(){return e=Object.assign||function(e){for(var r,n=1,t=arguments.length;n<t;n++)for(var a in r=arguments[n])Object.prototype.hasOwnProperty.call(r,a)&&(e[a]=r[a]);return e},e.apply(this,arguments)};function r(e,r,n){return{__name:e.__name,__primaryKey:e.__primaryKey,__has:r,__alias:n}}function n(e,r){for(var n=0,t=Object.entries(e);n<t.length;n++){var a=t[n],i=a[0],o=a[1];if(r[i]!==o)return!1}return!0}function t(e,r){var n={};function t(e){e.forEach((function(e){var t=r[e];t&&(n[e]=t)}))}return t("*"===e?Object.keys(r):e),n}function a(r,o,c){var _=c.from,s=c.where,u=c.fields,y=c.join;if(Array.isArray(s))return s.flatMap((function(n){return a(r,o,e(e({},c),{where:n}))}));var f=null,l=r[_],p=o[_];if(!p)return null;if("*"===s&&(f=Object.values(p).map((function(e){return t(u,e)}))),"object"==typeof s){var m=s[l.__primaryKey];if(m&&(f=t(u,p[m])),!m){f=[];for(var h=0,d=Object.entries(p);h<d.length;h++){var v=d[h];v[0],n(s,j=v[1])&&f.push(t(u,j))}}}if("function"==typeof s){f=[];for(var b=0,O=Object.entries(p);b<O.length;b++){var j,K=O[b];K[0],s(j=K[1])&&f.push(t(u,j))}}return f&&y&&(Array.isArray(f)&&f.forEach((function(e){i(e,{join:y,from:_,model:r,state:o})})),Array.isArray(f)||i(f,{join:y,from:_,model:r,state:o})),f}function i(e,r){var n=r.join,t=r.from,o=r.model,c=r.state,_=o[t];Object.values(n.reduce((function(e,r){return e[r.on]=r,e}),{})).forEach((function(r){var n,s=r.on,u=r.fields,y=r.join;if(e[s]){if(!_.__relationship[s])throw new Error('Field "'.concat(String(s),'" does not exist in object "').concat(t,'"'));if("hasOne"===_.__relationship[s].__has&&(e[s]=a(o,c,{fields:u,from:_.__relationship[s].__name,where:(n={},n[_.__relationship[s].__primaryKey]=e[s],n)})),"hasMany"===_.__relationship[s].__has){var f=[];e[s].forEach((function(e){var r,n=a(o,c,{fields:u,from:_.__relationship[s].__name,where:(r={},r[_.__relationship[s].__primaryKey]=e,r)});n&&f.push(n)})),e[s]=f}y&&("hasOne"===_.__relationship[s].__has&&i(e[s],{from:_.__relationship[s].__name,join:y,model:o,state:c}),"hasMany"===_.__relationship[s].__has&&e[s].forEach((function(e){i(e,{from:_.__relationship[s].__name,join:y,model:o,state:c})})))}}))}function o(e){if(null===e||"object"!=typeof e)return e;var r=Array.isArray(e)?[]:{};for(var n in e)e.hasOwnProperty(n)&&(r[n]=o(e[n]));return r}function c(e,r){if(e===r)return!0;if("object"!=typeof e||"object"!=typeof r||null===e||null===r)return!1;var n=Object.keys(e),t=Object.keys(r);if(n.length!==t.length)return!1;for(var a=0,i=n;a<i.length;a++){var o=i[a];if(!t.includes(o)||!c(e[o],r[o]))return!1}return!0}function _(e){var r=new Map;return function(){for(var n=[],t=0;t<arguments.length;t++)n[t]=arguments[t];var a=JSON.stringify(n),i=e.apply(void 0,n),o=r.get(a);return r.has(a)&&c(o,i)?o:(r.set(a,i),i)}}"function"==typeof SuppressedError&&SuppressedError,exports.createRelationalObject=function(n,t,a){var i,o=e(e({},t),{__name:n,__primaryKey:null!==(i=null==a?void 0:a.primaryKey)&&void 0!==i?i:"id",__relationship:{}});return Object.setPrototypeOf(o,{hasOne:function(e,n){var t=this,a=null!=n?n:e.__name,i=Object.entries(t.__relationship).find((function(r){return r[0],r[1].__name===e.__name}));if(i&&t.__relationship[i[0]].__primaryKey===e.__primaryKey&&e.__primaryKey===t.__name)throw new Error('"'.concat(e.__name,'" reference already exists in "').concat(t.__name,'" as "').concat(i[0],'" with the primary key (pk) "').concat(e.__primaryKey,'". "').concat(t.__name,'" table failed to create a hasOne relationship with "').concat(a,'" because it has the same primary key "').concat(e.__primaryKey,'" as "').concat(i[0],'". The primary key for "').concat(i[0],'" and "').concat(a,'" are not unique.'));return t[a]="hasOne",t.__relationship[a]=r(e,"hasOne",a),this},hasMany:function(e,n){var t=this,a=null!=n?n:e.__name,i=Object.entries(t.__relationship).find((function(r){return r[0],r[1].__name===e.__name}));if(i&&t.__relationship[i[0]].__primaryKey===e.__primaryKey&&e.__primaryKey===t.__name)throw new Error('"'.concat(e.__name,'" reference already exists in "').concat(t.__name,'" as "').concat(i[0],'" with the primary key (pk) "').concat(e.__primaryKey,'". "').concat(t.__name,'" table failed to create a hasOne relationship with "').concat(a,'" because it has the same primary key "').concat(e.__primaryKey,'" as "').concat(i[0],'". The primary key for "').concat(i[0],'" and "').concat(a,'" are not unique.'));return t[a]="hasMany",t.__relationship[a]=r(e,"hasMany",a),this}}),o},exports.createRelationalObjectIndex=function(e,r,n){return{__name:e,__objects:r.map((function(e){return e.__name})),__sort:null!=n?n:null}},exports.createStore=function(r){var n=r.relationalCreators,t=r.indexes,i=r.identifier,c={current:{},upsert:function(e){this.current[e.name]||(this.current[e.name]={}),this.current[e.name][e.primaryKey]?this.current[e.name][e.primaryKey].includes(e.ref)||this.current[e.name][e.primaryKey].push(e.ref):this.current[e.name][e.primaryKey]=[e.ref]}},s={},u=new Set,y=n.reduce((function(r,n){var t,a,i;n.hasOne,n.hasMany;var o=function(e,r){var n={};for(var t in e)Object.prototype.hasOwnProperty.call(e,t)&&r.indexOf(t)<0&&(n[t]=e[t]);if(null!=e&&"function"==typeof Object.getOwnPropertySymbols){var a=0;for(t=Object.getOwnPropertySymbols(e);a<t.length;a++)r.indexOf(t[a])<0&&Object.prototype.propertyIsEnumerable.call(e,t[a])&&(n[t[a]]=e[t[a]])}return n}(n,["hasOne","hasMany"]);if(!o[null!==(i=null===(a=o.__relationship[o.__primaryKey])||void 0===a?void 0:a.__name)&&void 0!==i?i:o.__primaryKey])throw new Error('The table "'.concat(o.__name,'" does not have a primary key (pk) "').concat(n.__primaryKey,'", pk should be listed here ').concat(JSON.stringify(n)));return e(e({},r),((t={})[o.__name]=o,t))}),{});null==t||t.forEach((function(e){return y[e.__name]=e}));var f=_((function(e){return a(y,s,e)})),l=_((function(r,n){var t=s[r],i=[];return t?(t.index.forEach((function(o){var c,_=t.objects[o],u=n?n[_.name]:{from:_.name,fields:"*"};if(!u)throw new Error('selectIndex() expected SelectOptions for "'.concat(_.name,'" in the index "').concat(r,'".'));var f=a(y,s,e(e({},u),{where:(c={},c[_.primaryKey]=_.primaryKeyValue,c)}));if(f)return(null==u?void 0:u.where)?void(("function"!=typeof(null==u?void 0:u.where)||(null==u?void 0:u.where(f)))&&i.push(f)):i.push(f)})),i):null}));return{getState:function(){return s},getReferences:function(){return c.current},purge:function(){for(var e in s){if(!Object.prototype.hasOwnProperty.call(s,e))return;delete s[e]}},select:f,selectIndex:l,upsert:function(e,r){var n,t=o(Array.isArray(e)?e:[e]),a=(null!==(n=null==r?void 0:r.indexes)&&void 0!==n?n:[]).map((function(e){return{model:y[e.index],key:e.key}}));function _(e){var r=e.name,n=e.item,t=e.parentName,a=e.primaryKey,i=e.parentPrimaryKey,o=e.relationalObject,c=Object.values(o.__relationship).find((function(e){return e.__name===t}));if(c&&("hasOne"===c.__has&&(s[r][n[a]][c.__alias]=i),"hasMany"===c.__has)){var _=s[r][n[a]][c.__alias];if(!Array.isArray(_))return void(s[r][n[a]][c.__alias]=[i]);!!_.find((function(e){return e===i}))||_.push(i)}}function f(e){var r=e.item,n=e.parentName,t=e.parentField,o=e.parentFieldHasMany,u=e.parentPrimaryKey,l=function(e){if(e.__identify__){var r=e.__identify__;return delete e.__identify__,r}for(var n in i)if(Object.prototype.hasOwnProperty.call(i,n)&&(0,i[n])(e))return n;throw new Error("Identifier was not able to identify this object ".concat(JSON.stringify(e)))}(r),p=y[l],m=p.__primaryKey;if(!r[m])throw new Error('Expected object "'.concat(l,'" to have a primaryKey "').concat(m,'".'));if(r.__destroy__)return function(e){var r=e.item,n=e.name,t=e.primaryKey;if(c.current[n]){var a=r[t];c.current[n][a].forEach((function(e){var r=e.split("."),n=r[0],t=r[1],i=r[2];if("hasMany"===y[n].__relationship[i].__has){var o=s[n][t][i].indexOf(a);-1!==o&&s[n][t][i].splice(o,1)}else delete s[n][t][i]})),delete s[n][r[t]]}}({item:r,name:l,primaryKey:m});if(s[l]||(s[l]={}),s[l][r[m]]||(s[l][r[m]]={}),n||a.forEach((function(e){var n=e.model,t=e.key;if(!r.__skipIndex__&&n.__objects.includes(l)){var a="".concat(n.__name,"-").concat(t);s[a]||(s[a]={index:[],objects:{}});var i="".concat(l,"-").concat(r[m]);s[a].objects[i]||(s[a].index.push(i),s[a].objects[i]={name:l,primaryKey:m,primaryKeyValue:r[m]})}})),Object.entries(r).forEach((function(e){var n=e[0],t=e[1];if(p.__relationship[n]){var a="hasMany"===p[n];if(!r[n])return;return a?void r[n].forEach((function(e){f({item:e,parentPrimaryKey:r[m],parentField:n,parentName:l,parentFieldHasMany:!0})})):void f({item:r[n],parentPrimaryKey:r[m],parentField:n,parentName:l})}s[l][r[m]][n]=t})),n&&t&&u){if(o){var h=s[n][u][t];return Array.isArray(h)?void(!!h.find((function(e){return e===r[m]}))||(c.upsert({name:l,primaryKey:r[m],ref:"".concat(n,".").concat(u,".").concat(t)}),h.push(r[m]),_({name:l,item:r,parentName:n,parentPrimaryKey:u,primaryKey:m,relationalObject:p}))):(c.upsert({name:l,primaryKey:r[m],ref:"".concat(n,".").concat(u,".").concat(t)}),s[n][u][t]=[r[m]],void _({name:l,item:r,parentName:n,parentPrimaryKey:u,primaryKey:m,relationalObject:p}))}c.upsert({name:l,primaryKey:r[m],ref:"".concat(n,".").concat(u,".").concat(t)}),s[n][u][t]=r[m],_({name:l,item:r,parentName:n,parentPrimaryKey:u,primaryKey:m,relationalObject:p})}}t.forEach((function(e){return!!e&&f({item:e})})),a.forEach((function(e){var r=e.model,n=e.key,t=r.__sort,a="".concat(r.__name,"-").concat(n);t&&s[a]&&s[a].index.sort((function(e,r){var n=s[a].objects[e],i=s[a].objects[r];return t(s[n.name][n.primaryKeyValue],s[i.name][i.primaryKeyValue])}))})),u.forEach((function(e){return e()}))},subscribe:function(e){return u.add(e),function(){return u.delete(e)}}}};
//# sourceMappingURL=index.js.map
