"use strict";var e=function(){return e=Object.assign||function(e){for(var r,n=1,a=arguments.length;n<a;n++)for(var t in r=arguments[n])Object.prototype.hasOwnProperty.call(r,t)&&(e[t]=r[t]);return e},e.apply(this,arguments)};function r(e,r,n){return{__name:e.__name,__primaryKey:e.__primaryKey,__has:r,__alias:n}}function n(e,r){for(var n=0,a=Object.entries(e);n<a.length;n++){var t=a[n],i=t[0],o=t[1];if(r[i]!==o)return!1}return!0}function a(e,r,n){var a={};function t(e){e.forEach((function(e){var t=n[e];if(t){var i=r.__relationship[e];return i?"hasOne"===i.__has?a[e]=t[i.__primaryKey]:void(a[e]=t.map((function(e){return e[i.__primaryKey]}))):a[e]=t}}))}return t("*"===e?Object.keys(n):e),a}function t(r,o,c){var _=c.from,s=c.where,y=c.fields,u=c.join;if(Array.isArray(s))return s.flatMap((function(n){return t(r,o,e(e({},c),{where:n}))}));var f=null,l=r[_],p=o[_];if(!p)return null;if("*"===s&&(f=Object.values(p).map((function(e){return a(y,l,e)}))),"object"==typeof s){var m=s[l.__primaryKey];if(m&&(f=a(y,l,p[m])),!m){f=[];for(var h=0,d=Object.entries(p);h<d.length;h++){var v=d[h];v[0],n(s,j=v[1])&&f.push(a(y,l,j))}}}if("function"==typeof s){f=[];for(var b=0,O=Object.entries(p);b<O.length;b++){var j,K=O[b];K[0],s(j=K[1])&&f.push(a(y,l,j))}}return f&&u&&(Array.isArray(f)&&f.forEach((function(e){i(e,{join:u,from:_,model:r,state:o})})),Array.isArray(f)||i(f,{join:u,from:_,model:r,state:o})),f}function i(e,r){var n=r.join,a=r.from,o=r.model,c=r.state,_=o[a];n.forEach((function(r){var n,s=r.on,y=r.fields,u=r.join;if(e[s]){if(!_.__relationship[s])throw new Error('Field "'.concat(String(s),'" does not exist in object "').concat(a,'"'));if("hasOne"===_.__relationship[s].__has&&(e[s]=t(o,c,{fields:y,from:_.__relationship[s].__name,where:(n={},n[_.__relationship[s].__primaryKey]=e[s],n)})),"hasMany"===_.__relationship[s].__has){var f=[];e[s].forEach((function(e){var r,n=t(o,c,{fields:y,from:_.__relationship[s].__name,where:(r={},r[_.__relationship[s].__primaryKey]=e,r)});n&&f.push(n)})),e[s]=f}u&&("hasOne"===_.__relationship[s].__has&&i(e[s],{from:_.__relationship[s].__name,join:u,model:o,state:c}),"hasMany"===_.__relationship[s].__has&&e[s].forEach((function(e){i(e,{from:_.__relationship[s].__name,join:u,model:o,state:c})})))}}))}function o(e,r){if(e===r)return!0;if("object"!=typeof e||"object"!=typeof r||null===e||null===r)return!1;var n=Object.keys(e),a=Object.keys(r);if(n.length!==a.length)return!1;for(var t=0,i=n;t<i.length;t++){var c=i[t];if(!a.includes(c)||!o(e[c],r[c]))return!1}return!0}function c(e){var r=new Map;return function(){for(var n=[],a=0;a<arguments.length;a++)n[a]=arguments[a];var t=JSON.stringify(n),i=e.apply(void 0,n),c=r.get(t);return r.has(t)&&o(c,i)?c:(r.set(t,i),i)}}"function"==typeof SuppressedError&&SuppressedError,exports.createRelationalObject=function(n,a,t){var i,o=e(e({},a),{__name:n,__primaryKey:null!==(i=null==t?void 0:t.primaryKey)&&void 0!==i?i:"id",__relationship:{}});return Object.setPrototypeOf(o,{hasOne:function(e,n){var a=this,t=null!=n?n:e.__name,i=Object.entries(a.__relationship).find((function(r){return r[0],r[1].__name===e.__name}));if(i&&a.__relationship[i[0]].__primaryKey===e.__primaryKey&&e.__primaryKey===a.__name)throw new Error('"'.concat(e.__name,'" reference already exists in "').concat(a.__name,'" as "').concat(i[0],'" with the primary key (pk) "').concat(e.__primaryKey,'". "').concat(a.__name,'" table failed to create a hasOne relationship with "').concat(t,'" because it has the same primary key "').concat(e.__primaryKey,'" as "').concat(i[0],'". The primary key for "').concat(i[0],'" and "').concat(t,'" are not unique.'));return a[t]="hasOne",a.__relationship[t]=r(e,"hasOne",t),this},hasMany:function(e,n){var a=this,t=null!=n?n:e.__name,i=Object.entries(a.__relationship).find((function(r){return r[0],r[1].__name===e.__name}));if(i&&a.__relationship[i[0]].__primaryKey===e.__primaryKey&&e.__primaryKey===a.__name)throw new Error('"'.concat(e.__name,'" reference already exists in "').concat(a.__name,'" as "').concat(i[0],'" with the primary key (pk) "').concat(e.__primaryKey,'". "').concat(a.__name,'" table failed to create a hasOne relationship with "').concat(t,'" because it has the same primary key "').concat(e.__primaryKey,'" as "').concat(i[0],'". The primary key for "').concat(i[0],'" and "').concat(t,'" are not unique.'));return a[t]="hasMany",a.__relationship[t]=r(e,"hasMany",t),this}}),o},exports.createRelationalObjectIndex=function(e,r,n){return{__name:e,__objects:r.map((function(e){return e.__name})),__sort:null!=n?n:null}},exports.createStore=function(r){var n=r.relationalCreators,a=r.indexes,i=r.identifier,o={},_=new Set,s=n.reduce((function(r,n){var a,t,i;n.hasOne,n.hasMany;var o=function(e,r){var n={};for(var a in e)Object.prototype.hasOwnProperty.call(e,a)&&r.indexOf(a)<0&&(n[a]=e[a]);if(null!=e&&"function"==typeof Object.getOwnPropertySymbols){var t=0;for(a=Object.getOwnPropertySymbols(e);t<a.length;t++)r.indexOf(a[t])<0&&Object.prototype.propertyIsEnumerable.call(e,a[t])&&(n[a[t]]=e[a[t]])}return n}(n,["hasOne","hasMany"]);if(!o[null!==(i=null===(t=o.__relationship[o.__primaryKey])||void 0===t?void 0:t.__name)&&void 0!==i?i:o.__primaryKey])throw new Error('The table "'.concat(o.__name,'" does not have a primary key (pk) "').concat(n.__primaryKey,'", pk should be listed here ').concat(JSON.stringify(n)));return e(e({},r),((a={})[o.__name]=o,a))}),{});null==a||a.forEach((function(e){return s[e.__name]=e}));var y=c((function(e){return t(s,o,e)})),u=c((function(r,n){var a=o[r],i=[];return a?(a.index.forEach((function(c){var _,y=a.objects[c],u=n?n[y.name]:{from:y.name,fields:"*"};if(!u)throw new Error('selectIndex() expected SelectOptions for "'.concat(y.name,'" in the index "').concat(r,'".'));var f=t(s,o,e(e({},u),{where:(_={},_[y.primaryKey]=y.primaryKeyValue,_)}));if(f)return(null==u?void 0:u.where)?void(("function"!=typeof(null==u?void 0:u.where)||(null==u?void 0:u.where(f)))&&i.push(f)):i.push(f)})),i):null}));return{getState:function(){return o},purge:function(){for(var e in o){if(!Object.prototype.hasOwnProperty.call(o,e))return;delete o[e]}},select:y,selectIndex:u,upsert:function(e,r){var n,a=Array.isArray(e)?e:[e],t=(null!==(n=null==r?void 0:r.indexes)&&void 0!==n?n:[]).map((function(e){return{model:s[e.index],key:e.key}}));function c(e){var r=e.name,n=e.item,a=e.parentName,t=e.primaryKey,i=e.parentPrimaryKey,c=e.relationalObject,_=Object.values(c.__relationship).find((function(e){return e.__name===a}));if(_&&("hasOne"===_.__has&&(o[r][n[t]][_.__alias]=o[a][i]),"hasMany"===_.__has)){var s=o[r][n[t]][_.__alias],y=o[a][i],u=Array.isArray(s);if(u||(o[r][n[t]][_.__alias]=[y]),u)!!s.find((function(e){return e[t]===y[t]}))||s.push(y)}}function y(e){var r=e.item,n=e.parentName,a=e.parentField,_=e.parentFieldHasMany,u=e.parentPrimaryKey;if(!r)return null;var f=function(e){if(e.__identify__){var r=e.__identify__;return delete e.__identify__,r}for(var n in i)if(Object.prototype.hasOwnProperty.call(i,n)&&(0,i[n])(e))return n;throw new Error("Identifier was not able to identify this object ".concat(JSON.stringify(e)))}(r),l=s[f],p=l.__primaryKey;if(!r[p])throw new Error('Expected object "'.concat(f,'" to have a primaryKey "').concat(p,'".'));if(o[f]||(o[f]={}),o[f][r[p]]||(o[f][r[p]]={}),n||t.forEach((function(e){var n=e.model,a=e.key;if(!r.__skipIndex__&&n.__objects.includes(f)){var t="".concat(n.__name,"-").concat(a);o[t]||(o[t]={index:[],objects:{}});var i="".concat(f,"-").concat(r[p]);o[t].objects[i]||(o[t].index.push(i),o[t].objects[i]={name:f,primaryKey:p,primaryKeyValue:r[p]})}})),Object.entries(r).forEach((function(e){var n=e[0],a=e[1];if(l.__relationship[n])return"hasMany"===l[n]?void r[n].forEach((function(e){y({item:e,parentPrimaryKey:r[p],parentField:n,parentName:f,parentFieldHasMany:!0})})):void y({item:r[n],parentPrimaryKey:r[p],parentField:n,parentName:f});o[f][r[p]][n]=a})),n&&a&&u){if(_){var m=o[n][u][a],h=o[f][r[p]];return Array.isArray(m)?void(!!m.find((function(e){return e[p]===h[p]}))||(m.push(h),c({name:f,item:r,parentName:n,parentPrimaryKey:u,primaryKey:p,relationalObject:l}))):(o[n][u][a]=[h],void c({name:f,item:r,parentName:n,parentPrimaryKey:u,primaryKey:p,relationalObject:l}))}c({name:f,item:r,parentName:n,parentPrimaryKey:u,primaryKey:p,relationalObject:l}),o[n][u][a]=o[f][r[p]]}}a.forEach((function(e){return y({item:e})})),t.forEach((function(e){var r=e.model,n=e.key,a=r.__sort,t="".concat(r.__name,"-").concat(n);a&&o[t]&&o[t].index.sort((function(e,r){var n=o[t].objects[e],i=o[t].objects[r];return a(o[n.name][n.primaryKeyValue],o[i.name][i.primaryKeyValue])}))})),_.forEach((function(e){return e()}))},subscribe:function(e){return _.add(e),function(){return _.delete(e)}}}};
//# sourceMappingURL=index.js.map
