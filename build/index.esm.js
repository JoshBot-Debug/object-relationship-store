var e=function(){return e=Object.assign||function(e){for(var r,n=1,a=arguments.length;n<a;n++)for(var t in r=arguments[n])Object.prototype.hasOwnProperty.call(r,t)&&(e[t]=r[t]);return e},e.apply(this,arguments)};function r(e,r,n){return{__name:e.__name,__primaryKey:e.__primaryKey,__has:r,__alias:n}}function n(n,a,t){var i,o=e(e({},a),{__name:n,__primaryKey:null!==(i=null==t?void 0:t.primaryKey)&&void 0!==i?i:"id",__relationship:{}});return Object.setPrototypeOf(o,{hasOne:function(e,n){var a=this,t=null!=n?n:e.__name,i=Object.entries(a.__relationship).find((function(r){return r[0],r[1].__name===e.__name}));if(i&&a.__relationship[i[0]].__primaryKey===e.__primaryKey&&e.__primaryKey===a.__name)throw new Error('"'.concat(e.__name,'" reference already exists in "').concat(a.__name,'" as "').concat(i[0],'" with the primary key (pk) "').concat(e.__primaryKey,'". "').concat(a.__name,'" table failed to create a hasOne relationship with "').concat(t,'" because it has the same primary key "').concat(e.__primaryKey,'" as "').concat(i[0],'". The primary key for "').concat(i[0],'" and "').concat(t,'" are not unique.'));return a[t]="hasOne",a.__relationship[t]=r(e,"hasOne",t),this},hasMany:function(e,n){var a=this,t=null!=n?n:e.__name,i=Object.entries(a.__relationship).find((function(r){return r[0],r[1].__name===e.__name}));if(i&&a.__relationship[i[0]].__primaryKey===e.__primaryKey&&e.__primaryKey===a.__name)throw new Error('"'.concat(e.__name,'" reference already exists in "').concat(a.__name,'" as "').concat(i[0],'" with the primary key (pk) "').concat(e.__primaryKey,'". "').concat(a.__name,'" table failed to create a hasOne relationship with "').concat(t,'" because it has the same primary key "').concat(e.__primaryKey,'" as "').concat(i[0],'". The primary key for "').concat(i[0],'" and "').concat(t,'" are not unique.'));return a[t]="hasMany",a.__relationship[t]=r(e,"hasMany",t),this}}),o}function a(e,r,n){return{__name:e,__objects:r.map((function(e){return e.__name})),__sort:null!=n?n:null}}function t(e,r){for(var n=0,a=Object.entries(e);n<a.length;n++){var t=a[n],i=t[0],o=t[1];if(r[i]!==o)return!1}return!0}function i(e,r){var n={};function a(e){e.forEach((function(e){var a=r[e];a&&(n[e]=a)}))}return a("*"===e?Object.keys(r):e),n}function o(r,n,a){var _=a.from,u=a.where,s=a.fields,y=a.join;if(Array.isArray(u))return u.flatMap((function(t){return o(r,n,e(e({},a),{where:t}))}));var f=null,p=r[_],l=n[_];if(!l)return null;if("*"===u&&(f=Object.values(l).map((function(e){return i(s,e)}))),"object"==typeof u){var m=u[p.__primaryKey];if(m&&(f=i(s,l[m])),!m){f=[];for(var h=0,d=Object.entries(l);h<d.length;h++){var v=d[h];v[0],t(u,K=v[1])&&f.push(i(s,K))}}}if("function"==typeof u){f=[];for(var b=0,O=Object.entries(l);b<O.length;b++){var K,j=O[b];j[0],u(K=j[1])&&f.push(i(s,K))}}return f&&y&&(Array.isArray(f)&&f.forEach((function(e){c(e,{join:y,from:_,model:r,state:n})})),Array.isArray(f)||c(f,{join:y,from:_,model:r,state:n})),f}function c(e,r){var n=r.join,a=r.from,t=r.model,i=r.state,_=t[a];Object.values(n.reduce((function(e,r){return e[r.on]=r,e}),{})).forEach((function(r){var n,u=r.on,s=r.fields,y=r.join;if(e[u]){if(!_.__relationship[u])throw new Error('Field "'.concat(String(u),'" does not exist in object "').concat(a,'"'));if("hasOne"===_.__relationship[u].__has&&(e[u]=o(t,i,{fields:s,from:_.__relationship[u].__name,where:(n={},n[_.__relationship[u].__primaryKey]=e[u],n)})),"hasMany"===_.__relationship[u].__has){var f=[];e[u].forEach((function(e){var r,n=o(t,i,{fields:s,from:_.__relationship[u].__name,where:(r={},r[_.__relationship[u].__primaryKey]=e,r)});n&&f.push(n)})),e[u]=f}y&&("hasOne"===_.__relationship[u].__has&&c(e[u],{from:_.__relationship[u].__name,join:y,model:t,state:i}),"hasMany"===_.__relationship[u].__has&&e[u].forEach((function(e){c(e,{from:_.__relationship[u].__name,join:y,model:t,state:i})})))}}))}function _(e){if(null===e||"object"!=typeof e)return e;var r=Array.isArray(e)?[]:{};for(var n in e)e.hasOwnProperty(n)&&(r[n]=_(e[n]));return r}function u(e,r){if(e===r)return!0;if("object"!=typeof e||"object"!=typeof r||null===e||null===r)return!1;var n=Object.keys(e),a=Object.keys(r);if(n.length!==a.length)return!1;for(var t=0,i=n;t<i.length;t++){var o=i[t];if(!a.includes(o)||!u(e[o],r[o]))return!1}return!0}function s(e){var r=new Map;return function(){for(var n=[],a=0;a<arguments.length;a++)n[a]=arguments[a];var t=JSON.stringify(n),i=e.apply(void 0,n),o=r.get(t);return r.has(t)&&u(o,i)?o:(r.set(t,i),i)}}function y(r){var n=r.relationalCreators,a=r.indexes,t=r.identifier,i={current:{},upsert:function(e){this.current[e.name]||(this.current[e.name]={}),this.current[e.name][e.primaryKey]?this.current[e.name][e.primaryKey].includes(e.ref)||this.current[e.name][e.primaryKey].push(e.ref):this.current[e.name][e.primaryKey]=[e.ref]}},c={},u=new Set,y=n.reduce((function(r,n){var a,t,i;n.hasOne,n.hasMany;var o=function(e,r){var n={};for(var a in e)Object.prototype.hasOwnProperty.call(e,a)&&r.indexOf(a)<0&&(n[a]=e[a]);if(null!=e&&"function"==typeof Object.getOwnPropertySymbols){var t=0;for(a=Object.getOwnPropertySymbols(e);t<a.length;t++)r.indexOf(a[t])<0&&Object.prototype.propertyIsEnumerable.call(e,a[t])&&(n[a[t]]=e[a[t]])}return n}(n,["hasOne","hasMany"]);if(!o[null!==(i=null===(t=o.__relationship[o.__primaryKey])||void 0===t?void 0:t.__name)&&void 0!==i?i:o.__primaryKey])throw new Error('The table "'.concat(o.__name,'" does not have a primary key (pk) "').concat(n.__primaryKey,'", pk should be listed here ').concat(JSON.stringify(n)));return e(e({},r),((a={})[o.__name]=o,a))}),{});null==a||a.forEach((function(e){return y[e.__name]=e}));var f=s((function(e){return o(y,c,e)})),p=s((function(r,n){var a=c[r],t=[];return a?(a.index.forEach((function(i){var _,u=a.objects[i],s=n?n[u.name]:{from:u.name,fields:"*"};if(!s)throw new Error('selectIndex() expected SelectOptions for "'.concat(u.name,'" in the index "').concat(r,'".'));var f=o(y,c,e(e({},s),{where:(_={},_[u.primaryKey]=u.primaryKeyValue,_)}));if(f)return(null==s?void 0:s.where)?void(("function"!=typeof(null==s?void 0:s.where)||(null==s?void 0:s.where(f)))&&t.push(f)):t.push(f)})),t):null}));return{getState:function(){return c},getReferences:function(){return i.current},purge:function(){for(var e in c){if(!Object.prototype.hasOwnProperty.call(c,e))return;delete c[e]}},select:f,selectIndex:p,upsert:function(e,r){var n,a=_(Array.isArray(e)?e:[e]),o=(null!==(n=null==r?void 0:r.indexes)&&void 0!==n?n:[]).map((function(e){return{model:y[e.index],key:e.key}}));function s(e){var r=e.name,n=e.item,a=e.parentName,t=e.primaryKey,i=e.parentPrimaryKey,o=e.relationalObject,_=Object.values(o.__relationship).find((function(e){return e.__name===a}));if(_&&("hasOne"===_.__has&&(c[r][n[t]][_.__alias]=i),"hasMany"===_.__has)){var u=c[r][n[t]][_.__alias];if(!Array.isArray(u))return void(c[r][n[t]][_.__alias]=[i]);!!u.find((function(e){return e===i}))||u.push(i)}}function f(e){var r=e.item,n=e.parentName,a=e.parentField,_=e.parentFieldHasMany,u=e.parentPrimaryKey,p=function(e){if(e.__identify__){var r=e.__identify__;return delete e.__identify__,r}for(var n in t)if(Object.prototype.hasOwnProperty.call(t,n)&&(0,t[n])(e))return n;throw new Error("Identifier was not able to identify this object ".concat(JSON.stringify(e)))}(r),l=y[p],m=l.__primaryKey;if(!r[m])throw new Error('Expected object "'.concat(p,'" to have a primaryKey "').concat(m,'".'));if(r.__destroy__)return function(e){var r=e.item,n=e.name,a=e.primaryKey;if(i.current[n]){var t=r[a];i.current[n][t].forEach((function(e){var r=e.split("."),n=r[0],a=r[1],i=r[2];if("hasMany"===y[n].__relationship[i].__has){var o=c[n][a][i].indexOf(t);-1!==o&&c[n][a][i].splice(o,1)}else delete c[n][a][i]})),delete c[n][r[a]]}}({item:r,name:p,primaryKey:m});if(c[p]||(c[p]={}),c[p][r[m]]||(c[p][r[m]]={}),n||o.forEach((function(e){var n=e.model,a=e.key;if(!r.__skipIndex__&&n.__objects.includes(p)){var t="".concat(n.__name,"-").concat(a);c[t]||(c[t]={index:[],objects:{}});var i="".concat(p,"-").concat(r[m]);c[t].objects[i]||(c[t].index.push(i),c[t].objects[i]={name:p,primaryKey:m,primaryKeyValue:r[m]})}})),Object.entries(r).forEach((function(e){var n=e[0],a=e[1];if(l.__relationship[n]){var t="hasMany"===l[n];if(!r[n])return;return t?void r[n].forEach((function(e){f({item:e,parentPrimaryKey:r[m],parentField:n,parentName:p,parentFieldHasMany:!0})})):void f({item:r[n],parentPrimaryKey:r[m],parentField:n,parentName:p})}c[p][r[m]][n]=a})),n&&a&&u){if(_){var h=c[n][u][a];return Array.isArray(h)?void(!!h.find((function(e){return e===r[m]}))||(i.upsert({name:p,primaryKey:r[m],ref:"".concat(n,".").concat(u,".").concat(a)}),h.push(r[m]),s({name:p,item:r,parentName:n,parentPrimaryKey:u,primaryKey:m,relationalObject:l}))):(i.upsert({name:p,primaryKey:r[m],ref:"".concat(n,".").concat(u,".").concat(a)}),c[n][u][a]=[r[m]],void s({name:p,item:r,parentName:n,parentPrimaryKey:u,primaryKey:m,relationalObject:l}))}i.upsert({name:p,primaryKey:r[m],ref:"".concat(n,".").concat(u,".").concat(a)}),c[n][u][a]=r[m],s({name:p,item:r,parentName:n,parentPrimaryKey:u,primaryKey:m,relationalObject:l})}}a.forEach((function(e){return!!e&&f({item:e})})),o.forEach((function(e){var r=e.model,n=e.key,a=r.__sort,t="".concat(r.__name,"-").concat(n);a&&c[t]&&c[t].index.sort((function(e,r){var n=c[t].objects[e],i=c[t].objects[r];return a(c[n.name][n.primaryKeyValue],c[i.name][i.primaryKeyValue])}))})),u.forEach((function(e){return e()}))},subscribe:function(e){return u.add(e),function(){return u.delete(e)}}}}"function"==typeof SuppressedError&&SuppressedError;export{n as createRelationalObject,a as createRelationalObjectIndex,y as createStore};
//# sourceMappingURL=index.esm.js.map
