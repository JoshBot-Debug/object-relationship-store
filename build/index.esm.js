function e(e,r,n){return{__name:e.__name,__primaryKey:e.__primaryKey,__has:r,__alias:n}}function r(r,n){var t={__name:r,__primaryKey:null!=n?n:"id",__relationship:{},__indexes:[]};return Object.setPrototypeOf(t,{hasOne:function(r,n){var t=this,a=null!=n?n:r.__name,i=Object.entries(t.__relationship).find((function(e){return e[0],e[1].__name===r.__name}));if(i&&t.__relationship[i[0]].__primaryKey===r.__primaryKey&&r.__primaryKey===t.__name)throw new Error('"'.concat(r.__name,'" reference already exists in "').concat(t.__name,'" as "').concat(i[0],'" with the primary key (pk) "').concat(r.__primaryKey,'". "').concat(t.__name,'" table failed to create a hasOne relationship with "').concat(a,'" because it has the same primary key "').concat(r.__primaryKey,'" as "').concat(i[0],'". The primary key for "').concat(i[0],'" and "').concat(a,'" are not unique.'));return t.__relationship[a]=e(r,"hasOne",a),this},hasMany:function(r,n){var t=this,a=null!=n?n:r.__name,i=Object.entries(t.__relationship).find((function(e){return e[0],e[1].__name===r.__name}));if(i&&t.__relationship[i[0]].__primaryKey===r.__primaryKey&&r.__primaryKey===t.__name)throw new Error('"'.concat(r.__name,'" reference already exists in "').concat(t.__name,'" as "').concat(i[0],'" with the primary key (pk) "').concat(r.__primaryKey,'". "').concat(t.__name,'" table failed to create a hasOne relationship with "').concat(a,'" because it has the same primary key "').concat(r.__primaryKey,'" as "').concat(i[0],'". The primary key for "').concat(i[0],'" and "').concat(a,'" are not unique.'));return t.__relationship[a]=e(r,"hasMany",a),this}}),t}function n(e,r,n){return{__name:e,__objects:r.map((function(e){return e.__name})),__sort:null!=n?n:null}}var t=function(){return t=Object.assign||function(e){for(var r,n=1,t=arguments.length;n<t;n++)for(var a in r=arguments[n])Object.prototype.hasOwnProperty.call(r,a)&&(e[a]=r[a]);return e},t.apply(this,arguments)};function a(e,r){for(var n=0,t=Object.entries(e);n<t.length;n++){var a=t[n],i=a[0],o=a[1];if(r[i]!==o)return!1}return!0}function i(e,r){if(!r)return{};var n={};function t(e){e.forEach((function(e){var t=r[e];t&&(n[e]=t)}))}return t("*"===e?Object.keys(r):e),n}function o(e,r,n){var _=n.from,u=n.where,s=n.fields,f=n.join;if(Array.isArray(u))return u.flatMap((function(a){return o(e,r,t(t({},n),{where:a}))}));var y=null,m=e[_],l=r[_];if(!l)return null;if("*"===u&&(y=Object.values(l).map((function(e){return i(s,e)}))),"object"==typeof u){var p=u[m.__primaryKey];if(p&&(y=i(s,l[p])),!p){y=[];for(var h=0,d=Object.entries(l);h<d.length;h++){var v=d[h];v[0],a(u,O=v[1])&&y.push(i(s,O))}}}if("function"==typeof u){y=[];for(var K=0,b=Object.entries(l);K<b.length;K++){var O,j=b[K];j[0],u(O=j[1])&&y.push(i(s,O))}}return y&&f&&(Array.isArray(y)&&y.forEach((function(n){c(n,{join:f,from:_,model:e,state:r})})),Array.isArray(y)||c(y,{join:f,from:_,model:e,state:r})),y}function c(e,r){var n=r.join,t=r.from,a=r.model,i=r.state,_=a[t];Object.values(n.reduce((function(e,r){return e[r.on]=r,e}),{})).forEach((function(r){var n,u=r.on,s=r.fields,f=r.join;if(e[u]){if(!_.__relationship[u])throw new Error('Field "'.concat(String(u),'" does not exist in object "').concat(t,'"'));if("hasOne"===_.__relationship[u].__has&&(e[u]=o(a,i,{fields:s,from:_.__relationship[u].__name,where:(n={},n[_.__relationship[u].__primaryKey]=e[u],n)})),"hasMany"===_.__relationship[u].__has){var y=[];e[u].forEach((function(e){var r,n=o(a,i,{fields:s,from:_.__relationship[u].__name,where:(r={},r[_.__relationship[u].__primaryKey]=e,r)});n&&y.push(n)})),e[u]=y}f&&("hasOne"===_.__relationship[u].__has&&c(e[u],{from:_.__relationship[u].__name,join:f,model:a,state:i}),"hasMany"===_.__relationship[u].__has&&e[u].forEach((function(e){c(e,{from:_.__relationship[u].__name,join:f,model:a,state:i})})))}}))}function _(e){if(null===e||"object"!=typeof e)return e;var r=Array.isArray(e)?[]:{};for(var n in e)e.hasOwnProperty(n)&&(r[n]=_(e[n]));return r}function u(e,r){if(e===r)return!0;if("object"!=typeof e||"object"!=typeof r||null===e||null===r)return!1;var n=Object.keys(e),t=Object.keys(r);if(n.length!==t.length)return!1;for(var a=0,i=n;a<i.length;a++){var o=i[a];if(!t.includes(o)||!u(e[o],r[o]))return!1}return!0}function s(e){var r=new Map;return function(){for(var n=[],t=0;t<arguments.length;t++)n[t]=arguments[t];var a=JSON.stringify(n),i=e.apply(void 0,n),o=r.get(a);return r.has(a)&&u(o,i)?o:(r.set(a,i),i)}}function f(e){var r,n,a=e.relationalCreators,i=e.indexes,c=e.identifier,u=e.initialStore,f={current:null!==(r=null==u?void 0:u.references)&&void 0!==r?r:{},upsert:function(e){this.current[e.name]||(this.current[e.name]={}),this.current[e.name][e.primaryKey]?this.current[e.name][e.primaryKey].includes(e.ref)||this.current[e.name][e.primaryKey].push(e.ref):this.current[e.name][e.primaryKey]=[e.ref]}},y=null!==(n=null==u?void 0:u.state)&&void 0!==n?n:{},m=new Set,l=a.reduce((function(e,r){var n;r.hasOne,r.hasMany;var a=function(e,r){var n={};for(var t in e)Object.prototype.hasOwnProperty.call(e,t)&&r.indexOf(t)<0&&(n[t]=e[t]);if(null!=e&&"function"==typeof Object.getOwnPropertySymbols){var a=0;for(t=Object.getOwnPropertySymbols(e);a<t.length;a++)r.indexOf(t[a])<0&&Object.prototype.propertyIsEnumerable.call(e,t[a])&&(n[t[a]]=e[t[a]])}return n}(r,["hasOne","hasMany"]);return t(t({},e),((n={})[a.__name]=a,n))}),{});null==i||i.forEach((function(e){return l[e.__name]=e}));var p=s((function(e){return o(l,y,e)})),h=s((function(e,r){var n=y[e],a=[];return n?(n.index.forEach((function(i){var c,_=n.objects[i],u=r?r[_.name]:{from:_.name,fields:"*"};if(!u)throw new Error('selectIndex() expected SelectOptions for "'.concat(_.name,'" in the index "').concat(e,'".'));var s=o(l,y,t(t({},u),{where:(c={},c[_.primaryKey]=_.primaryKeyValue,c)}));if(s)return(null==u?void 0:u.where)?void(("function"!=typeof(null==u?void 0:u.where)||(null==u?void 0:u.where(s)))&&a.push(s)):a.push(s)})),a):null}));return{save:function(e){e({state:y,references:f.current})},restore:function(e){f.current=e.references,Object.entries(e.state).map((function(e){var r=e[0],n=e[1];return y[r]=n}))},getState:function(){return y},getReferences:function(){return f.current},purge:function(){for(var e in y){if(!Object.prototype.hasOwnProperty.call(y,e))return;delete y[e]}f.current={}},select:p,selectIndex:h,upsert:function(e,r){var n,t=_(Array.isArray(e)?e:[e]),a=(null!==(n=null==r?void 0:r.indexes)&&void 0!==n?n:[]).map((function(e){return{model:l[e.index],key:e.key}}));function i(e){var r=e.item,n=e.name,t=e.primaryKey,a=l[n];Object.entries(a.__relationship).forEach((function(e){var a,o=e[0],c=e[1];if(y[n][r[t]]){var _=y[n][r[t]][o];if(_)if("hasMany"!==c.__has){var u=f.current[c.__name][_];if(u){var s=u.every((function(e){var a=e.split("."),i=a[0],o=a[1];return i===n&&o===String(r[t])}));if(!s)return;i({item:(a={},a[c.__primaryKey]=_,a),name:c.__name,primaryKey:c.__primaryKey}),delete f.current[c.__name][_],delete y[c.__name][_]}}else _.forEach((function(e){var a,o=f.current[c.__name][e].every((function(e){var a=e.split("."),i=a[0],o=a[1];return i===n&&o===String(r[t])}));o&&(i({item:(a={},a[c.__primaryKey]=e,a),name:c.__name,primaryKey:c.__primaryKey}),delete f.current[c.__name][e],delete y[c.__name][e])}))}})),delete y[n][r[t]],a.__indexes.forEach((function(e){var a=y[e],i="".concat(n,"-").concat(r[t]),o=a.index.indexOf(i);-1!==o&&(delete a.objects["".concat(n,"-").concat(r[t])],a.index.splice(o,1))}))}function o(e){var r=e.name,n=e.item,t=e.parentName,a=e.primaryKey,i=e.parentPrimaryKey,o=e.relationalObject,c=Object.values(o.__relationship).find((function(e){return e.__name===t}));if(c&&("hasOne"===c.__has&&(f.upsert({name:c.__name,primaryKey:i,ref:"".concat(r,".").concat(n[a],".").concat(c.__alias)}),y[r][n[a]][c.__alias]=i),"hasMany"===c.__has)){var _=y[r][n[a]][c.__alias];if(!Array.isArray(_))return f.upsert({name:c.__name,primaryKey:i,ref:"".concat(r,".").concat(n[a],".").concat(c.__alias)}),void(y[r][n[a]][c.__alias]=[i]);!!_.find((function(e){return e===i}))||(f.upsert({name:c.__name,primaryKey:i,ref:"".concat(r,".").concat(n[a],".").concat(c.__alias)}),_.push(i))}}function u(e){var r=e.item,n=e.parentName,t=e.parentField,_=e.parentFieldHasMany,s=e.parentPrimaryKey,m=function(e){if(e.__identify__){var r=e.__identify__;return delete e.__identify__,r}for(var n in c)if(Object.prototype.hasOwnProperty.call(c,n)&&(0,c[n])(e))return n;throw new Error("Identifier was not able to identify this object ".concat(JSON.stringify(e)))}(r),p=l[m],h=p.__primaryKey;if(!r[h])throw new Error('Expected object "'.concat(m,'" to have a primaryKey "').concat(h,'".'));if(r.__destroy__)return function(e){var r=e.item,n=e.name,t=e.primaryKey;if(f.current[n]){var a=r[t],o=f.current[n][a];o&&(o.forEach((function(e){var r=e.split("."),n=r[0],t=r[1],i=r[2];if(y[n][t])if("hasMany"===l[n].__relationship[i].__has){var o=y[n][t][i].indexOf(a);if(-1!==o){if(1===y[n][t][i].length)return void delete y[n][t][i];y[n][t][i].splice(o,1)}}else delete y[n][t][i]})),delete f.current[n][a]),i({item:r,name:n,primaryKey:t})}else i({item:r,name:n,primaryKey:t})}({item:r,name:m,primaryKey:h});if(y[m]||(y[m]={}),y[m][r[h]]||(y[m][r[h]]={}),n||a.forEach((function(e){var n=e.model,t=e.key;if(!r.__skipIndex__&&n.__objects.includes(m)){var a="".concat(n.__name,"-").concat(t);p.__indexes.includes(a)||p.__indexes.push(a),y[a]||(y[a]={index:[],objects:{}});var i="".concat(m,"-").concat(r[h]);y[a].objects[i]||(y[a].index.push(i),y[a].objects[i]={name:m,primaryKey:h,primaryKeyValue:r[h]})}})),Object.entries(r).forEach((function(e){var n=e[0],t=e[1];if(p.__relationship[n]){var a="hasMany"===p.__relationship[n].__has;if(!r[n])return;return a?void r[n].forEach((function(e){u({item:e,parentPrimaryKey:r[h],parentField:n,parentName:m,parentFieldHasMany:!0})})):void u({item:r[n],parentPrimaryKey:r[h],parentField:n,parentName:m})}y[m][r[h]][n]=t})),n&&t&&s){if(_){var d=y[n][s][t];return Array.isArray(d)?void(!!d.find((function(e){return e===r[h]}))||(f.upsert({name:m,primaryKey:r[h],ref:"".concat(n,".").concat(s,".").concat(t)}),d.push(r[h]),o({name:m,item:r,parentName:n,parentPrimaryKey:s,primaryKey:h,relationalObject:p}))):(f.upsert({name:m,primaryKey:r[h],ref:"".concat(n,".").concat(s,".").concat(t)}),y[n][s][t]=[r[h]],void o({name:m,item:r,parentName:n,parentPrimaryKey:s,primaryKey:h,relationalObject:p}))}f.upsert({name:m,primaryKey:r[h],ref:"".concat(n,".").concat(s,".").concat(t)}),y[n][s][t]=r[h],o({name:m,item:r,parentName:n,parentPrimaryKey:s,primaryKey:h,relationalObject:p})}}t.forEach((function(e){return!!e&&u({item:e})})),a.forEach((function(e){var r=e.model,n=e.key,t=r.__sort,a="".concat(r.__name,"-").concat(n);t&&y[a]&&y[a].index.sort((function(e,r){var n=y[a].objects[e],i=y[a].objects[r];return t(y[n.name][n.primaryKeyValue],y[i.name][i.primaryKeyValue])}))})),m.forEach((function(e){return e()}))},subscribe:function(e){return m.add(e),function(){return m.delete(e)}}}}"function"==typeof SuppressedError&&SuppressedError;export{r as createRelationalObject,n as createRelationalObjectIndex,f as createStore};
//# sourceMappingURL=index.esm.js.map
