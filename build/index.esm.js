var e=function(){return e=Object.assign||function(e){for(var r,n=1,a=arguments.length;n<a;n++)for(var t in r=arguments[n])Object.prototype.hasOwnProperty.call(r,t)&&(e[t]=r[t]);return e},e.apply(this,arguments)};function r(e,r,n){return{__name:e.__name,__primaryKey:e.__primaryKey,__has:r,__alias:n}}function n(n,a,t){var i,o=e(e({},a),{__name:n,__primaryKey:null!==(i=null==t?void 0:t.primaryKey)&&void 0!==i?i:"id",__relationship:{}});return Object.setPrototypeOf(o,{hasOne:function(e,n){var a=this,t=null!=n?n:e.__name,i=Object.entries(a.__relationship).find((function(r){return r[0],r[1].__name===e.__name}));if(i&&a.__relationship[i[0]].__primaryKey===e.__primaryKey&&e.__primaryKey===a.__name)throw new Error('"'.concat(e.__name,'" reference already exists in "').concat(a.__name,'" as "').concat(i[0],'" with the primary key (pk) "').concat(e.__primaryKey,'". "').concat(a.__name,'" table failed to create a hasOne relationship with "').concat(t,'" because it has the same primary key "').concat(e.__primaryKey,'" as "').concat(i[0],'". The primary key for "').concat(i[0],'" and "').concat(t,'" are not unique.'));return a[t]="hasOne",a.__relationship[t]=r(e,"hasOne",t),this},hasMany:function(e,n){var a=this,t=null!=n?n:e.__name,i=Object.entries(a.__relationship).find((function(r){return r[0],r[1].__name===e.__name}));if(i&&a.__relationship[i[0]].__primaryKey===e.__primaryKey&&e.__primaryKey===a.__name)throw new Error('"'.concat(e.__name,'" reference already exists in "').concat(a.__name,'" as "').concat(i[0],'" with the primary key (pk) "').concat(e.__primaryKey,'". "').concat(a.__name,'" table failed to create a hasOne relationship with "').concat(t,'" because it has the same primary key "').concat(e.__primaryKey,'" as "').concat(i[0],'". The primary key for "').concat(i[0],'" and "').concat(t,'" are not unique.'));return a[t]="hasMany",a.__relationship[t]=r(e,"hasMany",t),this}}),o}function a(e,r,n){return{__name:e,__objects:r.map((function(e){return e.__name})),__sort:null!=n?n:null}}function t(e,r){for(var n=0,a=Object.entries(e);n<a.length;n++){var t=a[n],i=t[0],o=t[1];if(r[i]!==o)return!1}return!0}function i(e,r,n){var a={};function t(e){e.forEach((function(e){var t=n[e],i=r.__relationship[e];return i?"hasOne"===i.__has?a[e]=t[i.__primaryKey]:void(a[e]=t.map((function(e){return e[i.__primaryKey]}))):a[e]=t}))}return t("*"===e?Object.keys(n):e),a}function o(r,n,a){var c=a.from,s=a.where,y=a.fields,f=a.join;if(Array.isArray(s))return s.flatMap((function(t){return o(r,n,e(e({},a),{where:t}))}));var u=null,p=r[c],m=n[c];if(!m)return null;if("*"===s&&(u=Object.values(m).map((function(e){return i(y,p,e)}))),"object"==typeof s){var l=s[p.__primaryKey];if(l&&(u=i(y,p,m[l])),!l){u=[];for(var h=0,d=Object.entries(m);h<d.length;h++){var v=d[h];v[0],t(s,K=v[1])&&u.push(i(y,p,K))}}}if("function"==typeof s){u=[];for(var O=0,b=Object.entries(m);O<b.length;O++){var K,j=b[O];j[0],s(K=j[1])&&u.push(i(y,p,K))}}if(u&&f){var w=Array.isArray(u);w&&u.forEach((function(e){_(e,{join:f,from:c,model:r,state:n})})),w||_(u,{join:f,from:c,model:r,state:n})}return u}function _(e,r){var n=r.join,a=r.from,t=r.model,i=r.state,c=t[a];n.forEach((function(r){var n,s=r.on,y=r.fields,f=r.join;if(e[s]){if(!c.__relationship[s])throw new Error('Field "'.concat(s,'" does not exist in object "').concat(a,'"'));if("hasOne"===c.__relationship[s].__has&&(e[s]=o(t,i,{fields:y,from:c.__relationship[s].__name,where:(n={},n[c.__relationship[s].__primaryKey]=e[s],n)})),"hasMany"===c.__relationship[s].__has){var u=[];e[s].forEach((function(e){var r,n=o(t,i,{fields:y,from:c.__relationship[s].__name,where:(r={},r[c.__relationship[s].__primaryKey]=e,r)});n&&u.push(n)})),e[s]=u}f&&("hasOne"===c.__relationship[s].__has&&_(e[s],{from:c.__relationship[s].__name,join:f,model:t,state:i}),"hasMany"===c.__relationship[s].__has&&e[s].forEach((function(e){_(e,{from:c.__relationship[s].__name,join:f,model:t,state:i})})))}}))}function c(r){var n=r.relationalCreators,a=r.indexes,t=r.identifier,i={},_=new Set,c=n.reduce((function(r,n){var a,t,i;n.hasOne,n.hasMany;var o=function(e,r){var n={};for(var a in e)Object.prototype.hasOwnProperty.call(e,a)&&r.indexOf(a)<0&&(n[a]=e[a]);if(null!=e&&"function"==typeof Object.getOwnPropertySymbols){var t=0;for(a=Object.getOwnPropertySymbols(e);t<a.length;t++)r.indexOf(a[t])<0&&Object.prototype.propertyIsEnumerable.call(e,a[t])&&(n[a[t]]=e[a[t]])}return n}(n,["hasOne","hasMany"]);if(!o[null!==(i=null===(t=o.__relationship[o.__primaryKey])||void 0===t?void 0:t.__name)&&void 0!==i?i:o.__primaryKey])throw new Error('The table "'.concat(o.__name,'" does not have a primary key (pk) "').concat(n.__primaryKey,'", pk should be listed here ').concat(JSON.stringify(n)));return e(e({},r),((a={})[o.__name]=o,a))}),{});null==a||a.forEach((function(e){return c[e.__name]=e}));var y=s((function(e){return o(c,i,e)})),f=s((function(r,n){var a=i[r],t=[];return a?(a.index.forEach((function(_){var s,y=a.objects[_],f=n?n[y.name]:{from:y.name,fields:"*"};if(!f)throw new Error('selectIndex() expected SelectOptions for "'.concat(y.name,'" in the index "').concat(r,'".'));var u=o(c,i,e(e({},f),{where:(s={},s[y.primaryKey]=y.primaryKeyValue,s)}));if(u)return(null==f?void 0:f.where)?void((null==f?void 0:f.where(u))&&t.push(u)):t.push(u)})),t):null}));return{getState:function(){return i},select:y,selectIndex:f,upsert:function(e,r){var n,a=Array.isArray(e)?e:[e],o=(null!==(n=null==r?void 0:r.indexes)&&void 0!==n?n:[]).map((function(e){return c[e]}));function s(e){var r=e.name,n=e.item,a=e.parentName,t=e.primaryKey,o=e.parentPrimaryKey,_=e.relationalObject,c=Object.values(_.__relationship).find((function(e){return e.__name===a}));if(c&&("hasOne"===c.__has&&(i[r][n[t]][c.__alias]=i[a][o]),"hasMany"===c.__has)){var s=i[r][n[t]][c.__alias],y=i[a][o],f=Array.isArray(s);if(f||(i[r][n[t]][c.__alias]=[y]),f)!!s.find((function(e){return e[t]===y[t]}))||s.push(y)}}function y(e){var r=e.item,n=e.parentName,a=e.parentField,_=e.parentFieldHasMany,f=e.parentPrimaryKey,u=function(e){for(var r in t)if(Object.prototype.hasOwnProperty.call(t,r)&&(0,t[r])(e))return r;throw new Error("Identifier was not able to identify this object ".concat(JSON.stringify(e)))}(r),p=c[u],m=p.__primaryKey;if(!r[m])throw new Error('Expected object "'.concat(u,'" to have a primaryKey "').concat(m,'".'));if(i[u]||(i[u]={}),i[u][r[m]]||(i[u][r[m]]={}),o.forEach((function(e){if(e.__objects.includes(u)){i[e.__name]||(i[e.__name]={index:[],objects:{}});var n="".concat(u,"-").concat(r[m]);i[e.__name].objects[n]||(i[e.__name].index.push(n),i[e.__name].objects[n]={name:u,primaryKey:m,primaryKeyValue:r[m]})}})),Object.entries(r).forEach((function(e){var n=e[0],a=e[1];if(p.__relationship[n])return"hasMany"===p[n]?void r[n].forEach((function(e){y({item:e,parentPrimaryKey:r[m],parentField:n,parentName:u,parentFieldHasMany:!0})})):void y({item:r[n],parentPrimaryKey:r[m],parentField:n,parentName:u});i[u][r[m]][n]=a})),n&&a&&f){if(_){var l=i[n][f][a],h=i[u][r[m]];return Array.isArray(l)?void(!!l.find((function(e){return e[m]===h[m]}))||(l.push(h),s({name:u,item:r,parentName:n,parentPrimaryKey:f,primaryKey:m,relationalObject:p}))):(i[n][f][a]=[h],void s({name:u,item:r,parentName:n,parentPrimaryKey:f,primaryKey:m,relationalObject:p}))}s({name:u,item:r,parentName:n,parentPrimaryKey:f,primaryKey:m,relationalObject:p}),i[n][f][a]=i[u][r[m]]}}a.forEach((function(e){return y({item:e})})),o.forEach((function(e){var r=e.__sort;r&&i[e.__name].index.sort((function(n,a){var t=i[e.__name].objects[n],o=i[e.__name].objects[a];return r(i[t.name][t.primaryKeyValue],i[t.name][o.primaryKeyValue])}))})),_.forEach((function(e){return e()}))},subscribe:function(e){return _.add(e),function(){return _.delete(e)}}}}function s(e){var r={};return function(){for(var n=[],a=0;a<arguments.length;a++)n[a]=arguments[a];var t=JSON.stringify(n),i=e.apply(void 0,n);return r[t]&&JSON.stringify(r[t])===JSON.stringify(i)?r[t]:(r[t]=i,i)}}"function"==typeof SuppressedError&&SuppressedError;export{n as createRelationalObject,a as createRelationalObjectIndex,c as createStore};
//# sourceMappingURL=index.esm.js.map
