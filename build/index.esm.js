function e(e,r,n){return{__name:e.__name,__primaryKey:e.__primaryKey,__has:r,__alias:n}}function r(r,n){var t={__name:r,__primaryKey:null!=n?n:"id",__relationship:{},__indexes:[]};return Object.setPrototypeOf(t,{hasOne:function(r,n){var t=this,a=null!=n?n:r.__name,i=Object.entries(t.__relationship).find((function(e){return e[0],e[1].__name===r.__name}));if(i&&t.__relationship[i[0]].__primaryKey===r.__primaryKey&&r.__primaryKey===t.__name)throw new Error('"'.concat(r.__name,'" reference already exists in "').concat(t.__name,'" as "').concat(i[0],'" with the primary key (pk) "').concat(r.__primaryKey,'". "').concat(t.__name,'" table failed to create a hasOne relationship with "').concat(a,'" because it has the same primary key "').concat(r.__primaryKey,'" as "').concat(i[0],'". The primary key for "').concat(i[0],'" and "').concat(a,'" are not unique.'));return t.__relationship[a]=e(r,"hasOne",a),this},hasMany:function(r,n){var t=this,a=null!=n?n:r.__name,i=Object.entries(t.__relationship).find((function(e){return e[0],e[1].__name===r.__name}));if(i&&t.__relationship[i[0]].__primaryKey===r.__primaryKey&&r.__primaryKey===t.__name)throw new Error('"'.concat(r.__name,'" reference already exists in "').concat(t.__name,'" as "').concat(i[0],'" with the primary key (pk) "').concat(r.__primaryKey,'". "').concat(t.__name,'" table failed to create a hasOne relationship with "').concat(a,'" because it has the same primary key "').concat(r.__primaryKey,'" as "').concat(i[0],'". The primary key for "').concat(i[0],'" and "').concat(a,'" are not unique.'));return t.__relationship[a]=e(r,"hasMany",a),this}}),t}function n(e,r,n){return{__name:e,__objects:r.map((function(e){return e.__name})),__sort:null!=n?n:null}}var t=function(){return t=Object.assign||function(e){for(var r,n=1,t=arguments.length;n<t;n++)for(var a in r=arguments[n])Object.prototype.hasOwnProperty.call(r,a)&&(e[a]=r[a]);return e},t.apply(this,arguments)};function a(e,r){for(var n=0,t=Object.entries(e);n<t.length;n++){var a=t[n],i=a[0],_=a[1];if(r[i]!==_)return!1}return!0}function i(e,r){if(!r)return null;var n={};function t(e){e.forEach((function(e){var t=r[e];void 0!==t&&(n[e]=t)}))}return t("*"===e?Object.keys(r):e),n}function _(e,r,n){var c=n.from,s=n.where,u=n.fields,f=n.join;if(Array.isArray(s))return s.flatMap((function(a){var i;return null!==(i=_(e,r,t(t({},n),{where:a})))&&void 0!==i?i:[]}));var y=null,l=e[c],p=r[c];if(!p)return null;if("*"===s&&(y=Object.values(p).flatMap((function(e){var r;return null!==(r=i(u,e))&&void 0!==r?r:[]}))),"object"==typeof s){var m=s[l.__primaryKey];if(m)(j=i(u,p[m]))&&(y=j);if(!m){y=[];for(var h=0,d=Object.entries(p);h<d.length;h++){var v=d[h];if(v[0],a(s,O=v[1]))(j=i(u,O))&&y.push(j)}}}if("function"==typeof s){y=[];for(var K=0,b=Object.entries(p);K<b.length;K++){var O,j,x=b[K];if(x[0],s(O=x[1]))(j=i(u,O))&&y.push(j)}}return y&&f&&(Array.isArray(y)&&y.forEach((function(n){o(n,{join:f,from:c,model:e,state:r})})),Array.isArray(y)||o(y,{join:f,from:c,model:e,state:r})),y}function o(e,r){var n=r.join,t=r.from,a=r.model,i=r.state,c=a[t];Object.values(n.reduce((function(e,r){return e[r.on]=r,e}),{})).forEach((function(r){var n,s=r.on,u=r.fields,f=r.join;if(e[s]){if(!c.__relationship[s])throw new Error('Field "'.concat(String(s),'" does not exist in object "').concat(t,'"'));if("hasOne"===c.__relationship[s].__has&&(e[s]=_(a,i,{fields:u,from:c.__relationship[s].__name,where:(n={},n[c.__relationship[s].__primaryKey]=e[s],n)})),"hasMany"===c.__relationship[s].__has){var y=[];e[s].forEach((function(e){var r,n=_(a,i,{fields:u,from:c.__relationship[s].__name,where:(r={},r[c.__relationship[s].__primaryKey]=e,r)});n&&y.push(n)})),e[s]=y}f&&("hasOne"===c.__relationship[s].__has&&o(e[s],{from:c.__relationship[s].__name,join:f,model:a,state:i}),"hasMany"===c.__relationship[s].__has&&e[s].forEach((function(e){o(e,{from:c.__relationship[s].__name,join:f,model:a,state:i})})))}}))}function c(e){if(null===e||"object"!=typeof e)return e;var r=Array.isArray(e)?[]:{};for(var n in e)e.hasOwnProperty(n)&&(r[n]=c(e[n]));return r}function s(e,r){if(e===r)return!0;if("object"!=typeof e||"object"!=typeof r||null===e||null===r)return!1;var n=Object.keys(e),t=Object.keys(r);if(n.length!==t.length)return!1;for(var a=0,i=n;a<i.length;a++){var _=i[a];if(!t.includes(_)||!s(e[_],r[_]))return!1}return!0}function u(e){var r=new Map;return function(){for(var n=[],t=0;t<arguments.length;t++)n[t]=arguments[t];var a=JSON.stringify(n),i=e.apply(void 0,n),_=r.get(a);return r.has(a)&&s(_,i)?_:(r.set(a,i),i)}}function f(e){var r,n,a=e.relationalCreators,i=e.indexes,o=e.identifier,s=e.initialStore,f={current:null!==(r=null==s?void 0:s.references)&&void 0!==r?r:{},upsert:function(e){this.current[e.name]||(this.current[e.name]={}),this.current[e.name][e.primaryKey]?this.current[e.name][e.primaryKey].includes(e.ref)||this.current[e.name][e.primaryKey].push(e.ref):this.current[e.name][e.primaryKey]=[e.ref]}},y=null!==(n=null==s?void 0:s.state)&&void 0!==n?n:{},l=new Set,p=a.reduce((function(e,r){var n;r.hasOne,r.hasMany;var a=function(e,r){var n={};for(var t in e)Object.prototype.hasOwnProperty.call(e,t)&&r.indexOf(t)<0&&(n[t]=e[t]);if(null!=e&&"function"==typeof Object.getOwnPropertySymbols){var a=0;for(t=Object.getOwnPropertySymbols(e);a<t.length;a++)r.indexOf(t[a])<0&&Object.prototype.propertyIsEnumerable.call(e,t[a])&&(n[t[a]]=e[t[a]])}return n}(r,["hasOne","hasMany"]);return t(t({},e),((n={})[a.__name]=a,n))}),{});null==i||i.forEach((function(e){return p[e.__name]=e}));var m=u((function(e){return _(p,y,e)})),h=u((function(e,r){var n=y[e],a=[];return n?(n.index.forEach((function(i){var o,c=n.objects[i],s=r?r[c.name]:{from:c.name,fields:"*"};if(!s)throw new Error('selectIndex() expected SelectOptions for "'.concat(c.name,'" in the index "').concat(e,'".'));var u=_(p,y,t(t({},s),{where:(o={},o[c.primaryKey]=c.primaryKeyValue,o)}));if(u)return(null==s?void 0:s.where)?void(("function"!=typeof(null==s?void 0:s.where)||(null==s?void 0:s.where(u)))&&a.push(u)):a.push(u)})),a):null}));return{save:function(e){e({state:y,references:f.current})},restore:function(e){f.current=e.references,Object.entries(e.state).map((function(e){var r=e[0],n=e[1];return y[r]=n}))},getState:function(){return y},getReferences:function(){return f.current},purge:function(){for(var e in y){if(!Object.prototype.hasOwnProperty.call(y,e))return;delete y[e]}f.current={}},select:m,selectIndex:h,upsert:function(e){var r=c(Array.isArray(e)?e:[e]),n=r.reduce((function(e,r){if(r.__indexes__){var n=r.__indexes__.map((function(e){return e.split("-")}));e.push.apply(e,n)}return e}),[]);function t(e){var r=e.item,n=e.name,a=e.primaryKey,i=p[n];Object.entries(i.__relationship).forEach((function(e){var i,_=e[0],o=e[1];if(y[n][r[a]]){var c=y[n][r[a]][_];if(c)if("hasMany"!==o.__has){var s=f.current[o.__name][c];if(s){var u=s.every((function(e){var t=e.split("."),i=t[0],_=t[1];return i===n&&_===String(r[a])}));if(!u)return;t({item:(i={},i[o.__primaryKey]=c,i),name:o.__name,primaryKey:o.__primaryKey}),delete f.current[o.__name][c],delete y[o.__name][c]}}else c.forEach((function(e){var i,_=f.current[o.__name][e].every((function(e){var t=e.split("."),i=t[0],_=t[1];return i===n&&_===String(r[a])}));_&&(t({item:(i={},i[o.__primaryKey]=e,i),name:o.__name,primaryKey:o.__primaryKey}),delete f.current[o.__name][e],delete y[o.__name][e])}))}})),delete y[n][r[a]],i.__indexes.forEach((function(e){var t=y[e],i="".concat(n,"-").concat(r[a]),_=t.index.indexOf(i);-1!==_&&(delete t.objects["".concat(n,"-").concat(r[a])],t.index.splice(_,1))}))}function a(e){var r=e.name,n=e.item,t=e.parentName,a=e.primaryKey,i=e.parentPrimaryKey,_=e.relationalObject,o=Object.values(_.__relationship).find((function(e){return e.__name===t}));if(o&&("hasOne"===o.__has&&(f.upsert({name:o.__name,primaryKey:i,ref:"".concat(r,".").concat(n[a],".").concat(o.__alias)}),y[r][n[a]][o.__alias]=i),"hasMany"===o.__has)){var c=y[r][n[a]][o.__alias];if(!Array.isArray(c))return f.upsert({name:o.__name,primaryKey:i,ref:"".concat(r,".").concat(n[a],".").concat(o.__alias)}),void(y[r][n[a]][o.__alias]=[i]);!!c.find((function(e){return e===i}))||(f.upsert({name:o.__name,primaryKey:i,ref:"".concat(r,".").concat(n[a],".").concat(o.__alias)}),c.push(i))}}function i(e){var r,n=e.item,_=e.parentName,c=e.parentField,s=e.parentFieldHasMany,u=e.parentPrimaryKey,l=function(e){if("__identify__"in e){var r=e.__identify__;return delete e.__identify__,r}for(var n in delete e.__identify__,o)if(Object.prototype.hasOwnProperty.call(o,n)&&(0,o[n])(e))return n;throw new Error("Identifier was not able to identify this object ".concat(JSON.stringify(e)))}(n),m=p[l],h=m.__primaryKey;if(!n[h])throw new Error('Expected object "'.concat(l,'" to have a primaryKey "').concat(h,'".'));if("__destroy__"in n){if(n.__destroy__)return function(e){var r=e.item,n=e.name,a=e.primaryKey;if(y[n])if(f.current[n]){var i=r[a],_=f.current[n][i];_&&(_.forEach((function(e){var r=e.split("."),n=r[0],t=r[1],a=r[2];if(y[n][t])if("hasMany"===p[n].__relationship[a].__has){var _=y[n][t][a].indexOf(i);if(-1!==_){if(1===y[n][t][a].length)return void delete y[n][t][a];y[n][t][a].splice(_,1)}}else delete y[n][t][a]})),delete f.current[n][i]),t({item:r,name:n,primaryKey:a})}else t({item:r,name:n,primaryKey:a})}({item:n,name:l,primaryKey:h});delete n.__destroy__}if(y[l]||(y[l]={}),y[l][n[h]]||(y[l][n[h]]={}),_||"__indexes__"in n&&(null===(r=n.__indexes__)||void 0===r||r.forEach((function(e){var r=e.split("-")[0],t=p[r];if(null==t?void 0:t.__objects.includes(l)){m.__indexes.includes(e)||m.__indexes.push(e),y[e]||(y[e]={index:[],objects:{}});var a="".concat(l,"-").concat(n[h]);y[e].objects[a]||(y[e].index.push(a),y[e].objects[a]={name:l,primaryKey:h,primaryKeyValue:n[h]})}})),delete n.__indexes__),Object.entries(n).forEach((function(e){var r=e[0],t=e[1];if(m.__relationship[r]){var a="hasMany"===m.__relationship[r].__has;if(!n[r])return;return a?void n[r].forEach((function(e){i({item:e,parentPrimaryKey:n[h],parentField:r,parentName:l,parentFieldHasMany:!0})})):void i({item:n[r],parentPrimaryKey:n[h],parentField:r,parentName:l})}y[l][n[h]][r]=t})),_&&c&&u){if(s){var d=y[_][u][c];return Array.isArray(d)?void(!!d.find((function(e){return e===n[h]}))||(f.upsert({name:l,primaryKey:n[h],ref:"".concat(_,".").concat(u,".").concat(c)}),d.push(n[h]),a({name:l,item:n,parentName:_,parentPrimaryKey:u,primaryKey:h,relationalObject:m}))):(f.upsert({name:l,primaryKey:n[h],ref:"".concat(_,".").concat(u,".").concat(c)}),y[_][u][c]=[n[h]],void a({name:l,item:n,parentName:_,parentPrimaryKey:u,primaryKey:h,relationalObject:m}))}f.upsert({name:l,primaryKey:n[h],ref:"".concat(_,".").concat(u,".").concat(c)}),y[_][u][c]=n[h],a({name:l,item:n,parentName:_,parentPrimaryKey:u,primaryKey:h,relationalObject:m})}}r.forEach((function(e){return!!e&&i({item:e})})),null==n||n.forEach((function(e){var r=e[0],n=e[1],t=p[r].__sort,a="".concat(r,"-").concat(n);t&&y[a]&&y[a].index.sort((function(e,r){var n=y[a].objects[e],i=y[a].objects[r];return t(y[n.name][n.primaryKeyValue],y[i.name][i.primaryKeyValue])}))})),l.forEach((function(e){return e()}))},subscribe:function(e){return l.add(e),function(){return l.delete(e)}},destroy:function(e){delete y[e]}}}function y(e,r){return Array.isArray(e)?e.map((function(e){return l(e,r)})):l(e,r)}function l(e,r){return"function"==typeof r.__destroy__?e.__destroy__=r.__destroy__(e):r.__destroy__&&(e.__destroy__=r.__destroy__),"function"==typeof r.__identify__?e.__identify__=r.__identify__(e):r.__identify__&&(e.__identify__=r.__identify__),"function"==typeof r.__indexes__?e.__indexes__=r.__indexes__(e):r.__indexes__&&(e.__indexes__=r.__indexes__),e}"function"==typeof SuppressedError&&SuppressedError;export{r as createRelationalObject,n as createRelationalObjectIndex,f as createStore,y as withOptions};
//# sourceMappingURL=index.esm.js.map
